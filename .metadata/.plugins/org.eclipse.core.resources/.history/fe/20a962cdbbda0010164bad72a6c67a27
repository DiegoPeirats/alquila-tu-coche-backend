package com.alquilatucoche.usuarios.infrastructura.seguridad;

import java.sql.Date;
import java.time.LocalDate;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Component;

import com.alquilatucoche.usuarios.aplicacion.respuesta.excepciones.UsuarioNoEncontradoExcepcion;
import com.alquilatucoche.usuarios.dominio.entidad.Usuario;
import com.alquilatucoche.usuarios.infrastructura.repositorio.RepositorioUsuario;

import lombok.RequiredArgsConstructor;

@Component
@RequiredArgsConstructor
public class JwtTokenProvider {
	
    @Value("${app.jwt-secret}")
    private String jwtSecret;
    
    @Value("${app.jwt-expiration}")
    private long jwtExpirationDate;
    
    private final RepositorioUsuario repositorio;
    
    public String generateToken (Authentication authentication) {
    	
    	String emailUsuario = authentication.getName();
    	
    	Date fechaActual = Date.valueOf(LocalDate.now());
    	
    	Date fechaExpiracion = new Date(fechaActual.getTime() + jwtExpirationDate);
    	
    	Usuario usuarioEncontrado = repositorio.findByEmail(emailUsuario)
    			.orElseThrow(() -> new UsuarioNoEncontradoExcepcion());
    	
    	return Jwts.builder()
    			.setSubject(emailUsuario)
    			.claim("id", usuarioEncontrado.getId())
    			.setIssuedAt(fechaActual)
    			.setExpiration(fechaExpiracion)
    			.signWith(key())
    			.compact();
    	
    	
    	
    	
    	return null;
    }

}
