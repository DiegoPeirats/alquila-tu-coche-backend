package com.alquilatucoche.usuarios.aplicacion.servicio;

import java.util.List;

import org.springframework.stereotype.Service;

import com.alquilatucoche.usuarios.aplicacion.respuesta.UsuarioDTO;
import com.alquilatucoche.usuarios.aplicacion.respuesta.excepciones.UsuarioNoEncontradoExcepcion;
import com.alquilatucoche.usuarios.aplicacion.utiles.UsuarioMapper;
import com.alquilatucoche.usuarios.dominio.entidad.Usuario;
import com.alquilatucoche.usuarios.dominio.servicio.ServicioUsuario;
import com.alquilatucoche.usuarios.infrastructura.peticiones.PeticionAltaUsuario;
import com.alquilatucoche.usuarios.infrastructura.peticiones.PeticionModificacionUsuario;
import com.alquilatucoche.usuarios.infrastructura.repositorio.RepositorioUsuario;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class ImplementacionServicioUsuario implements ServicioUsuario{
	
	private final RepositorioUsuario repositorio;
	
	private final UsuarioMapper mapper;

	@Override
	public UsuarioDTO altaUsuario(PeticionAltaUsuario peticion) {
		
		peticion.setPropietario(false);
		
		Usuario usuario = repositorio.save(
				UsuarioMapper.mapper.crearUsuarioDesdePeticion(peticion)
				);
		

		return UsuarioMapper.INSTANCE.toDto(usuario);
	}

	@Override
	public String bajaUsuario(Long id) {
		try {
			repositorio.deleteById(id);
			return "Usuario dado de baja con Ã©xito";
		}catch(Exception e) {
			return e.getMessage();
		}
	}

	@Override
	public UsuarioDTO modificacionUsuario(PeticionModificacionUsuario peticion) {
		

	    Usuario usuario = repositorio.findById(peticion.getId())
	            .orElseThrow(UsuarioNoEncontradoExcepcion::new);


	    peticion.setId(null);


	    UsuarioMapper.INSTANCE.actualizarUsuarioDesdePeticion(peticion, usuario);


	    Usuario usuarioActualizado = repositorio.save(usuario);


	    return UsuarioMapper.INSTANCE.toDto(usuarioActualizado);
	}

	@Override
	public UsuarioDTO busquedaUsuario(Long id) {
		return repositorio.findById(id)
				.map(usuario -> UsuarioMapper.INSTANCE.toDto(usuario))
				.orElseThrow(UsuarioNoEncontradoExcepcion::new);
	}

	@Override
	public List<UsuarioDTO> recuperacionListaUsuarios() {
		return repositorio.findAll().stream()
				.map(usuario -> UsuarioMapper.INSTANCE.toDto(usuario))
				.toList();
	}

}
