package com.alquilatucoche.usuarios.infrastructura.seguridad;

import java.security.Key;
import java.sql.Date;
import java.time.LocalDate;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Component;

import com.alquilatucoche.usuarios.aplicacion.respuesta.excepciones.UsuarioNoEncontradoExcepcion;
import com.alquilatucoche.usuarios.dominio.entidad.Usuario;
import com.alquilatucoche.usuarios.infrastructura.repositorio.RepositorioUsuario;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.security.Keys;
import lombok.RequiredArgsConstructor;

@Component
@RequiredArgsConstructor
public class ProveedorJwtToken {
	
    @Value("${app.jwt-secret}")
    private String jwtSecret;
    
    @Value("${app.jwt-expiration}")
    private long jwtExpirationDate;
    
    private final RepositorioUsuario repositorio;
    
    public String generateToken (Authentication authentication) {
    	
    	String emailUsuario = authentication.getName();
    	
    	Date fechaActual = Date.valueOf(LocalDate.now());
    	
    	Date fechaExpiracion = new Date(fechaActual.getTime() + jwtExpirationDate);
    	
    	Usuario usuarioEncontrado = repositorio.findByEmail(emailUsuario)
    			.orElseThrow(() -> new UsuarioNoEncontradoExcepcion());
    	
    	return Jwts.builder()
    			.setSubject(emailUsuario)
    			.claim("id", usuarioEncontrado.getId())
    			.setIssuedAt(fechaActual)
    			.setExpiration(fechaExpiracion)
    			.signWith(key())
    			.compact();
    	
    }

	private Key key() {
    	byte[] bytes = Decoders.BASE64.decode(jwtSecret);
    	return Keys.hmacShaKeyFor(bytes);
	}

	public boolean validarToken(String token) {
		Jwts.parserBuilder()
		.setSigningKey(key())
		.build()
		.parseClaimsJws(token);
		return false;
	}

	public String getUsername(String token) {
		Claims claims = Jwts.parserBuilder()
				.setSigningKey(key())
				.build()
				.parseClaimsJws(token)
				.getBody();
		return claims.getSubject();
	}
	
	

}
